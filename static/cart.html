<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cart - Laundry App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Razorpay -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{background:#f8f9fa;padding-bottom:90px}
.header{background:#198754;color:#fff;padding:15px;text-align:center;font-size:18px;font-weight:600}
.card-box{background:#fff;border-radius:10px;padding:15px;margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.slot{border:1px solid #ddd;padding:10px;border-radius:8px;margin-bottom:8px;cursor:pointer}
.slot.active{background:#198754;color:#fff;border-color:#198754}
.footer-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ddd;padding:12px}
</style>
</head>

<body>

<div class="header">Cart & Pickup</div>

<div class="container my-3">

<!-- SUMMARY -->
<div class="card-box">
<h6>Order Summary</h6>
<div id="cartItems"></div>
<hr>
<strong>Total: ₹<span id="totalAmount">0</span></strong>
</div>

<!-- DATE -->
<div class="card-box">
<h6>Pickup Date</h6>
<input type="date" id="pickupDate" class="form-control">
</div>

<!-- SLOT -->
<div class="card-box">
<h6>Pickup Time Slot</h6>
<div class="slot" onclick="selectSlot(this)">10:00 – 12:00</div>
<div class="slot" onclick="selectSlot(this)">12:00 – 14:00</div>
<div class="slot" onclick="selectSlot(this)">14:00 – 16:00</div>
<div class="slot" onclick="selectSlot(this)">16:00 – 18:00</div>
<div class="slot" onclick="selectSlot(this)">18:00 – 20:00</div>
</div>

<!-- PAYMENT -->
<div class="card-box">
<h6>Payment</h6>
<strong>Online UPI Payment</strong>
</div>

</div>

<!-- FOOTER -->
<div class="footer-bar">
<button class="btn btn-success w-100" onclick="payNow()">
Pay & Continue →
</button>
</div>

<script>
// LOAD CART
const cart = JSON.parse(localStorage.getItem("cart")||"{}");
let total=0, html="";

if(Object.keys(cart).length===0){
 alert("Cart empty"); location.href="/";
}

Object.values(cart).forEach(i=>{
 let t=i.qty*i.price;
 total+=t;
 html+=`<div class="d-flex justify-content-between mb-1">
 <div>${i.name} × ${i.qty}</div><div>₹${t}</div></div>`;
});

cartItems.innerHTML=html;
totalAmount.innerText=total;

// SLOT
function selectSlot(el){
 document.querySelectorAll(".slot").forEach(s=>s.classList.remove("active"));
 el.classList.add("active");
}

// PAYMENT
function payNow(){

 let date=pickupDate.value;
 let slot=document.querySelector(".slot.active");

 if(!date||!slot){
   alert("Select date & slot"); return;
 }

 localStorage.setItem("pickup_date",date);
 localStorage.setItem("pickup_slot",slot.innerText);

 fetch("/create_payment",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({amount:Number(total)})
 })
 .then(r=>r.json())
 .then(order=>{

   var options={
     key:"rzp_live_S4Sq8zIR6ztzan",
     amount:order.amount,
     currency:"INR",
     name:"Laundry App",
     description:"Laundry Order",
     order_id:order.id,

     handler:function(res){

       let data={
         phone:localStorage.getItem("phone"),
         address:localStorage.getItem("address"),
         items:JSON.parse(localStorage.getItem("cart")),
         pickup_date:localStorage.getItem("pickup_date"),
         pickup_slot:localStorage.getItem("pickup_slot"),
         payment_id:res.razorpay_payment_id
       };

       fetch("/place_order",{
         method:"POST",
         headers:{"Content-Type":"application/json"},
         body:JSON.stringify(data)
       })
       .then(()=>location.href="/static/success.html");
     },

     modal:{
       ondismiss:function(){alert("Payment cancelled")}
     }
   };

   new Razorpay(options).open();
 });
}
</script>

</body>
</html>

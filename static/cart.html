<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cart - Laundry App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Razorpay -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background:#f8f9fa;
      padding-bottom:90px;
    }
    .header {
      background:#198754;
      color:white;
      padding:15px;
      text-align:center;
      font-size:18px;
      font-weight:600;
    }
    .card-box {
      background:white;
      border-radius:10px;
      padding:15px;
      margin-bottom:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    .slot {
      border:1px solid #ddd;
      padding:10px;
      border-radius:8px;
      margin-bottom:8px;
      cursor:pointer;
    }
    .slot.active {
      background:#198754;
      color:white;
      border-color:#198754;
    }
    .footer-bar {
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:white;
      border-top:1px solid #ddd;
      padding:12px;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  Cart & Pickup
</div>

<div class="container my-3">

  <!-- CART SUMMARY -->
  <div class="card-box">
    <h6 class="mb-2">Order Summary</h6>
    <div id="cartItems"></div>
    <hr>
    <strong>Total: ₹<span id="totalAmount">0</span></strong>
  </div>

  <!-- PICKUP DATE -->
  <div class="card-box">
    <h6 class="mb-2">Pickup Date</h6>
    <input type="date" id="pickupDate" class="form-control">
  </div>

  <!-- PICKUP SLOT -->
  <div class="card-box">
    <h6 class="mb-2">Pickup Time Slot</h6>

    <div class="slot" onclick="selectSlot(this)">10:00 – 12:00</div>
    <div class="slot" onclick="selectSlot(this)">12:00 – 14:00</div>
    <div class="slot" onclick="selectSlot(this)">14:00 – 16:00</div>
    <div class="slot" onclick="selectSlot(this)">16:00 – 18:00</div>
    <div class="slot" onclick="selectSlot(this)">18:00 – 20:00</div>
  </div>

  <!-- PAYMENT -->
  <div class="card-box">
    <h6 class="mb-2">Payment</h6>
    <strong>Online UPI Payment</strong>
  </div>

</div>

<!-- FOOTER -->
<div class="footer-bar">
  <button class="btn btn-success w-100" onclick="continueOrder()">
    Pay & Continue →
  </button>
</div>

<script>
/* LOAD CART */
const cart = JSON.parse(localStorage.getItem("cart") || "{}");
let total = 0;
let html = "";

if (Object.keys(cart).length === 0) {
  alert("Cart is empty");
  window.location.href = "/";
}

Object.values(cart).forEach(item => {
  const itemTotal = item.qty * item.price;
  total += itemTotal;

  html += `
    <div class="d-flex justify-content-between mb-1">
      <div>${item.name} × ${item.qty}</div>
      <div>₹${itemTotal}</div>
    </div>
  `;
});

document.getElementById("cartItems").innerHTML = html;
document.getElementById("totalAmount").innerText = total;

/* SLOT SELECTION */
function selectSlot(el) {
  document.querySelectorAll(".slot").forEach(s => s.classList.remove("active"));
  el.classList.add("active");
}

/* PAYMENT */
function continueOrder() {

  const date = pickupDate.value;
  const slot = document.querySelector(".slot.active");

  if (!date || !slot) {
    alert("Please select pickup date & slot");
    return;
  }

  localStorage.setItem("pickup_date", date);
  localStorage.setItem("pickup_slot", slot.innerText);

  console.log("TOTAL SENT:", total); // DEBUG

  fetch("/create_payment", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      amount: Number(total)   // FORCE number
    })
  })
  .then(r => r.json())
  .then(order => {

    var options = {
      key: "rzp_live_S4Sq8zIR6ztzan",
      amount: order.amount,
      currency: "INR",
      name: "Laundry App",
      description: "Laundry Order",
      order_id: order.id,

      handler: function (response){
        localStorage.setItem("payment_id", response.razorpay_payment_id);
        window.location.href = "/static/otp.html";
      }
    };

    var rzp = new Razorpay(options);
    rzp.open();
  });
}

</script>

</body>
</html>


